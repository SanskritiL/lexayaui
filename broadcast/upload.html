<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Post - Broadcast</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/broadcast/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <a href="./" class="logo">‚Üê Back to Dashboard</a>
            <h1>Create New Post</h1>
            <p class="tagline">Upload once, publish everywhere</p>
        </header>

        <!-- Auth Check -->
        <div id="auth-required" class="auth-required" style="display: none;">
            <div class="card">
                <h2>Login Required</h2>
                <p>Please login to create posts</p>
                <a href="/login.html?redirect=/broadcast/upload.html" class="btn btn-primary">Login with Email</a>
            </div>
        </div>

        <!-- Upload Form -->
        <main id="upload-form" style="display: none;">
            <form id="post-form" autocomplete="off">
                <!-- Step 1: Media Upload (Video or Photo) -->
                <section class="section">
                    <h2>1. Upload Media <span style="font-weight: normal; font-size: 0.9rem; color: var(--text-light);">(optional for LinkedIn/Threads)</span></h2>
                    <div class="upload-zone" id="upload-zone">
                        <div class="upload-icon">üì∑</div>
                        <h3>Drop your photo or video here</h3>
                        <p>or click to browse</p>
                        <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">
                            üì∏ Images: JPG, PNG, WebP &nbsp;|&nbsp; üé¨ Videos: MP4, MOV
                        </p>
                        <input type="file" id="media-input" accept="image/jpeg,image/png,image/webp,image/gif,video/mp4,video/quicktime,video/mov" hidden>
                    </div>
                    <!-- Video Preview -->
                    <div id="video-preview-container" style="display: none; margin-top: 1rem;">
                        <video id="video-preview" class="video-preview" controls style="max-height: 400px; width: auto; max-width: 100%;"></video>
                        <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem;">
                            <p id="video-info" style="color: var(--text-light); font-size: 0.9rem; margin: 0;"></p>
                            <button type="button" id="remove-media" class="btn btn-secondary btn-small">Remove</button>
                        </div>
                        <!-- Hook Analyzer Button -->
                        <div id="hook-analyzer-container" style="margin-top: 1rem;">
                            <button type="button" id="analyze-hook-btn" class="btn btn-secondary" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                                Analyze Hook
                            </button>
                            <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem; text-align: center;">
                                Get AI-powered suggestions to make your hook more viral
                            </p>
                        </div>
                    </div>
                    <!-- Image Preview -->
                    <div id="image-preview-container" style="display: none; margin-top: 1rem;">
                        <img id="image-preview" style="max-width: 100%; max-height: 400px; border-radius: 8px; object-fit: contain;">
                        <div style="display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem;">
                            <p id="image-info" style="color: var(--text-light); font-size: 0.9rem; margin: 0;"></p>
                            <button type="button" id="remove-image" class="btn btn-secondary btn-small">Remove</button>
                        </div>
                        <p style="font-size: 0.85rem; color: #f59e0b; margin-top: 0.5rem;">
                            ‚ö†Ô∏è TikTok requires video - it will be disabled for photo posts
                        </p>
                    </div>
                </section>

                <!-- Step 2: Caption -->
                <section class="section">
                    <h2>2. Add Caption</h2>
                    <div class="form-group">
                        <label for="caption">Caption (will be used across all platforms)</label>
                        <textarea id="caption" name="caption" placeholder="Write your caption here... Include hashtags at the end!"></textarea>
                        <p style="margin-top: 0.5rem; color: var(--text-light); font-size: 0.85rem;">
                            <span id="char-count">0</span>/2200 characters
                        </p>
                    </div>
                </section>

                <!-- Step 3: Select Platforms -->
                <section class="section">
                    <h2>3. Select Platforms</h2>
                    <div class="platforms-select" id="platforms-select" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div data-platform="tiktok" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                            <input type="checkbox" id="platform-tiktok" name="platforms" value="tiktok" disabled style="width: 20px; height: 20px; accent-color: #1e40af;">
                            <label for="platform-tiktok" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; flex: 1;">
                                <span style="font-size: 1.5rem;">üéµ</span>
                                <span style="font-weight: 500;">TikTok</span>
                            </label>
                            <span class="status" style="font-size: 0.85rem; color: #9ca3af;">(Connect first)</span>
                        </div>
                        <div data-platform="instagram" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                            <input type="checkbox" id="platform-instagram" name="platforms" value="instagram" disabled style="width: 20px; height: 20px; accent-color: #1e40af;">
                            <label for="platform-instagram" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; flex: 1;">
                                <span style="font-size: 1.5rem;">üì∏</span>
                                <span style="font-weight: 500;">Instagram</span>
                            </label>
                            <span class="status" style="font-size: 0.85rem; color: #9ca3af;">(Connect first)</span>
                        </div>
                        <div data-platform="linkedin" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                            <input type="checkbox" id="platform-linkedin" name="platforms" value="linkedin" disabled style="width: 20px; height: 20px; accent-color: #1e40af;">
                            <label for="platform-linkedin" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; flex: 1;">
                                <span style="font-size: 1.5rem;">üíº</span>
                                <span style="font-weight: 500;">LinkedIn</span>
                            </label>
                            <span class="status" style="font-size: 0.85rem; color: #9ca3af;">(Connect first)</span>
                        </div>
                        <div data-platform="threads" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                            <input type="checkbox" id="platform-threads" name="platforms" value="threads" disabled style="width: 20px; height: 20px; accent-color: #1e40af;">
                            <label for="platform-threads" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; flex: 1;">
                                <span style="font-size: 1.5rem;">üßµ</span>
                                <span style="font-weight: 500;">Threads</span>
                            </label>
                            <span class="status" style="font-size: 0.85rem; color: #9ca3af;">(Connect first)</span>
                        </div>
                    </div>
                    <p id="no-accounts-warning" style="margin-top: 1rem; color: var(--warning);">
                        No accounts connected. <a href="connect.html">Connect an account</a> to start posting.
                    </p>
                </section>

                <!-- Step 4: Schedule (Optional) -->
                <section class="section">
                    <h2>4. Schedule (Optional)</h2>
                    <div class="form-group">
                        <label for="schedule-toggle" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="schedule-toggle" style="width: auto;">
                            <span>Schedule for later</span>
                        </label>
                    </div>
                    <div id="schedule-fields" style="display: none;">
                        <div class="form-group">
                            <label for="schedule-date">Date & Time</label>
                            <input type="datetime-local" id="schedule-date" name="schedule_date">
                        </div>
                    </div>
                </section>

                <!-- Submit -->
                <section class="section">
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" id="save-draft">Save as Draft</button>
                        <button type="submit" class="btn btn-primary" id="publish-btn" disabled>
                            Publish Now
                        </button>
                    </div>
                </section>
            </form>
        </main>

        <!-- Publishing Progress Modal -->
        <div id="publishing-modal" class="modal" style="display: none;">
            <div class="modal-content publishing-modal">
                <div class="modal-header">
                    <div class="modal-icon" id="modal-icon">
                        <div class="spinner"></div>
                    </div>
                    <h2 id="modal-title">Publishing your post...</h2>
                    <p id="modal-subtitle" class="modal-subtitle">This may take a moment</p>
                </div>
                <div id="publish-progress" class="publish-progress">
                    <!-- Progress items will be added dynamically -->
                </div>
                <div id="modal-actions" class="modal-actions" style="display: none;">
                    <a href="./" class="btn btn-primary">Back to Dashboard</a>
                </div>
            </div>
        </div>

        <!-- Hook Analysis Modal -->
        <div id="hook-analysis-modal" class="modal" style="display: none;">
            <div class="modal-content hook-analysis-modal">
                <button type="button" class="modal-close" id="close-analysis-modal">&times;</button>

                <div class="modal-header">
                    <h2>Hook Analysis</h2>
                    <p class="modal-subtitle">AI-powered viral potential assessment</p>
                </div>

                <!-- Viral Score -->
                <div class="viral-score-container">
                    <div class="viral-score-ring">
                        <svg viewBox="0 0 100 100">
                            <circle class="score-bg" cx="50" cy="50" r="45"/>
                            <circle class="score-progress" id="score-circle" cx="50" cy="50" r="45"/>
                        </svg>
                        <div class="score-value" id="viral-score-value">--</div>
                    </div>
                    <p class="score-label" id="score-label">Viral Score</p>
                </div>

                <!-- Extracted Text -->
                <div class="analysis-section" id="extracted-text-section">
                    <h3><i class="fa-solid fa-closed-captioning"></i> Detected Hook Text</h3>
                    <div class="extracted-text" id="extracted-text-display">
                        <em>Analyzing...</em>
                    </div>
                </div>

                <!-- Strengths & Weaknesses -->
                <div class="analysis-row">
                    <div class="analysis-section strengths">
                        <h3><i class="fa-solid fa-check-circle"></i> What's Working</h3>
                        <ul id="strengths-list"></ul>
                    </div>
                    <div class="analysis-section weaknesses">
                        <h3><i class="fa-solid fa-exclamation-circle"></i> Could Improve</h3>
                        <ul id="weaknesses-list"></ul>
                    </div>
                </div>

                <!-- Suggestions -->
                <div class="analysis-section suggestions">
                    <h3><i class="fa-solid fa-lightbulb"></i> Suggestions</h3>
                    <ul id="suggestions-list"></ul>
                </div>

                <!-- Similar Viral Hooks -->
                <div class="analysis-section similar-hooks" id="similar-hooks-section" style="display: none;">
                    <h3><i class="fa-solid fa-fire"></i> Similar Viral Hooks</h3>
                    <div class="similar-hooks-grid" id="similar-hooks-grid"></div>
                </div>

                <div class="modal-actions" style="display: block; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-primary" id="close-analysis-btn" style="width: 100%;">Got it</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Config
        const SUPABASE_URL = 'https://bcyhcsphmqizzvzmdqxc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjeWhjc3BobXFpenp2em1kcXhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNjEwMjQsImV4cCI6MjA4MTczNzAyNH0.8CGKr_2IzxmdcCidKE0pIpsGJnkDKIYmNxDtns2ZRFk';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let selectedFile = null;
        let selectedMediaType = null; // 'image' or 'video'
        let connectedAccounts = [];
        let currentUser = null;
        let videoThumbnailBlob = null;
        const ADMIN_EMAILS = ['sanslamsal16@gmail.com'];


        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, initializing...');
            const { data: { user } } = await supabaseClient.auth.getUser();
            currentUser = user;
            console.log('User:', currentUser ? currentUser.email : 'not logged in');

            if (!currentUser) {
                document.getElementById('auth-required').style.display = 'flex';
                document.getElementById('upload-form').style.display = 'none';
                return;
            }

            // Admin bypass - skip subscription check
            if (!ADMIN_EMAILS.includes(currentUser.email)) {
                const { data: subscription } = await supabaseClient
                    .from('subscriptions')
                    .select('*')
                    .eq('customer_email', currentUser.email)
                    .eq('product_key', 'broadcast')
                    .eq('status', 'active')
                    .single();

                if (!subscription) {
                    window.location.href = '/broadcast/pricing.html';
                    return;
                }
            }

            document.getElementById('auth-required').style.display = 'none';
            document.getElementById('upload-form').style.display = 'block';

            // Reset all checkboxes on page load (prevent browser form restore)
            document.querySelectorAll('input[name="platforms"]').forEach(cb => {
                cb.checked = false;
            });

            await loadConnectedAccounts();
            setupEventListeners();
            console.log('Setup complete, ready to post!');
        });

        // Load connected accounts and update platform checkboxes
        async function loadConnectedAccounts() {
            if (!currentUser) return;

            console.log('Loading connected accounts for user:', currentUser.id);

            const { data: accounts, error } = await supabaseClient
                .from('connected_accounts')
                .select('*')
                .eq('user_id', currentUser.id);

            console.log('Connected accounts:', accounts);
            console.log('Error:', error);

            connectedAccounts = accounts || [];
            updatePlatformCheckboxes();
        }

        function updatePlatformCheckboxes() {
            const platforms = ['tiktok', 'instagram', 'linkedin', 'threads'];
            const warning = document.getElementById('no-accounts-warning');
            const hasMedia = !!selectedFile;
            const hasVideo = hasMedia && selectedMediaType === 'video';
            const hasImage = hasMedia && selectedMediaType === 'image';

            let hasAnyConnected = false;

            platforms.forEach(platform => {
                const container = document.querySelector(`[data-platform="${platform}"]`);
                const input = container.querySelector('input');
                const status = container.querySelector('.status');
                const account = connectedAccounts.find(a => a.platform === platform);

                console.log(`Platform ${platform}:`, { account: !!account, hasVideo, hasImage });

                if (account) {
                    hasAnyConnected = true;

                    // TikTok requires video (no image support)
                    if (platform === 'tiktok') {
                        if (hasImage) {
                            input.disabled = true;
                            input.checked = false;
                            status.textContent = '(Video only)';
                            status.style.color = '#f59e0b';
                            container.style.opacity = '0.6';
                        } else if (!hasVideo) {
                            input.disabled = true;
                            input.checked = false;
                            status.textContent = '(Requires video)';
                            status.style.color = '#f59e0b';
                            container.style.opacity = '0.6';
                        } else {
                            input.disabled = false;
                            status.textContent = account.account_name ? `@${account.account_name}` : '‚úì Connected';
                            status.style.color = '#10b981';
                            container.style.opacity = '1';
                        }
                    }
                    // Instagram supports both video (Reels) and images (Posts)
                    else if (platform === 'instagram') {
                        if (!hasMedia) {
                            input.disabled = true;
                            input.checked = false;
                            status.textContent = '(Requires media)';
                            status.style.color = '#f59e0b';
                            container.style.opacity = '0.6';
                        } else {
                            input.disabled = false;
                            const mediaTypeLabel = hasImage ? 'üì∑' : 'üé¨';
                            status.textContent = `${mediaTypeLabel} @${account.account_name || 'Connected'}`;
                            status.style.color = '#10b981';
                            container.style.opacity = '1';
                        }
                    }
                    // LinkedIn and Threads support text, images, and videos
                    else {
                        input.disabled = false;
                        status.textContent = account.account_name ? `@${account.account_name}` : '‚úì Connected';
                        status.style.color = '#10b981';
                        container.style.opacity = '1';
                    }
                } else {
                    input.disabled = true;
                    status.textContent = '(Connect first)';
                    status.style.color = '#9ca3af';
                    container.style.opacity = '0.6';
                }
            });

            if (hasAnyConnected) {
                warning.style.display = 'none';
            }

            updatePublishButton();
        }

        function setupEventListeners() {
            // Upload zone
            const uploadZone = document.getElementById('upload-zone');
            const mediaInput = document.getElementById('media-input');

            uploadZone.addEventListener('click', () => mediaInput.click());

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && (file.type.startsWith('video/') || file.type.startsWith('image/'))) {
                    handleFileSelect(file);
                }
            });

            mediaInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            // Remove media buttons (video and image)
            document.getElementById('remove-media').addEventListener('click', clearMedia);
            document.getElementById('remove-image').addEventListener('click', clearMedia);

            // Setup form event listeners
            setupFormEventListeners();
        }

        function clearMedia() {
            selectedFile = null;
            selectedMediaType = null;
            videoThumbnailBlob = null;

            const uploadZone = document.getElementById('upload-zone');
            const videoPreviewContainer = document.getElementById('video-preview-container');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const videoPreview = document.getElementById('video-preview');
            const imagePreview = document.getElementById('image-preview');

            uploadZone.classList.remove('has-file');
            uploadZone.innerHTML = `
                <div class="upload-icon">üì∑</div>
                <h3>Drop your photo or video here</h3>
                <p>or click to browse</p>
                <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">
                    üì∏ Images: JPG, PNG, WebP &nbsp;|&nbsp; üé¨ Videos: MP4, MOV
                </p>
                <input type="file" id="media-input" accept="image/jpeg,image/png,image/webp,image/gif,video/mp4,video/quicktime,video/mov" hidden>
            `;
            videoPreviewContainer.style.display = 'none';
            imagePreviewContainer.style.display = 'none';
            videoPreview.src = '';
            imagePreview.src = '';

            // Re-attach file input listener
            document.getElementById('media-input').addEventListener('change', (e) => {
                if (e.target.files[0]) handleFileSelect(e.target.files[0]);
            });
            // Re-attach click to open file dialog
            document.getElementById('upload-zone').addEventListener('click', () => {
                document.getElementById('media-input').click();
            });

            updatePlatformCheckboxes();
        }

        function setupFormEventListeners() {
            // Caption counter
            const caption = document.getElementById('caption');
            const charCount = document.getElementById('char-count');
            caption.addEventListener('input', () => {
                charCount.textContent = caption.value.length;
                updatePublishButton();
            });

            // Platform selection - listen on checkboxes directly
            document.querySelectorAll('input[name="platforms"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    console.log('Platform checkbox changed:', checkbox.value, checkbox.checked);
                    updatePublishButton();
                });
            });

            // Schedule toggle
            const scheduleToggle = document.getElementById('schedule-toggle');
            const scheduleFields = document.getElementById('schedule-fields');
            scheduleToggle.addEventListener('change', () => {
                scheduleFields.style.display = scheduleToggle.checked ? 'block' : 'none';
                updatePublishButton();
            });

            // Form submit
            document.getElementById('post-form').addEventListener('submit', handleSubmit);

            // Publish button click (in case form submit doesn't work)
            const publishBtn = document.getElementById('publish-btn');
            console.log('Publish button found:', publishBtn);
            console.log('Publish button disabled:', publishBtn?.disabled);

            if (publishBtn) {
                publishBtn.addEventListener('click', (e) => {
                    console.log('Publish button clicked!');
                    e.preventDefault();
                    handleSubmit(e, false);
                });
            }

            // Save draft
            document.getElementById('save-draft').addEventListener('click', () => {
                console.log('Save draft clicked!');
                handleSubmit(null, true);
            });
        }

        // Max file size in MB
        const MAX_FILE_SIZE_MB = 500;

        async function handleFileSelect(file) {
            const sizeMB = file.size / (1024 * 1024);

            // Check absolute max file size
            if (sizeMB > MAX_FILE_SIZE_MB) {
                alert(`File too large! Max size is ${MAX_FILE_SIZE_MB}MB.\n\nYour file: ${sizeMB.toFixed(2)}MB`);
                return;
            }

            selectedFile = file;
            const isImage = file.type.startsWith('image/');
            const isVideo = file.type.startsWith('video/');
            selectedMediaType = isImage ? 'image' : 'video';

            const uploadZone = document.getElementById('upload-zone');
            const videoPreviewContainer = document.getElementById('video-preview-container');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const videoPreview = document.getElementById('video-preview');
            const imagePreview = document.getElementById('image-preview');
            const videoInfo = document.getElementById('video-info');
            const imageInfo = document.getElementById('image-info');

            // Hide both preview containers first
            videoPreviewContainer.style.display = 'none';
            imagePreviewContainer.style.display = 'none';

            uploadZone.classList.add('has-file');

            if (isImage) {
                // Handle image
                uploadZone.innerHTML = `
                    <div class="upload-icon">üì∑</div>
                    <h3>${file.name}</h3>
                    <p>Click to change image</p>
                `;
                imagePreview.src = URL.createObjectURL(file);
                imagePreviewContainer.style.display = 'block';
                imageInfo.textContent = `Size: ${sizeMB.toFixed(2)} MB`;
            } else if (isVideo) {
                // Handle video
                uploadZone.innerHTML = `
                    <div class="upload-icon">üé¨</div>
                    <h3>${file.name}</h3>
                    <p>Click to change video</p>
                `;
                videoPreview.src = URL.createObjectURL(file);
                videoPreviewContainer.style.display = 'block';
                videoInfo.textContent = `Size: ${sizeMB.toFixed(2)} MB`;

                // Generate thumbnail when video loads
                videoPreview.onloadeddata = () => generateThumbnail(videoPreview);
            }

            updatePlatformCheckboxes();
        }

        // Generate thumbnail from video using canvas
        async function generateThumbnail(videoElement) {
            return new Promise((resolve) => {
                // Seek to 1 second or 10% of video, whichever is smaller
                const seekTime = Math.min(1, videoElement.duration * 0.1);
                videoElement.currentTime = seekTime;

                videoElement.onseeked = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

                    canvas.toBlob((blob) => {
                        videoThumbnailBlob = blob;
                        console.log('[THUMBNAIL] Generated:', (blob.size / 1024).toFixed(2), 'KB');
                        resolve(blob);
                    }, 'image/jpeg', 0.8);
                };
            });
        }

        function updatePublishButton() {
            const btn = document.getElementById('publish-btn');
            const selectedPlatforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked'));
            const scheduleToggle = document.getElementById('schedule-toggle');
            const caption = document.getElementById('caption').value.trim();

            // Check if only text-friendly platforms are selected (LinkedIn, Threads)
            const textFriendlyPlatforms = ['linkedin', 'threads'];
            const onlyTextFriendly = selectedPlatforms.every(p => textFriendlyPlatforms.includes(p.value));
            const hasVideoRequired = selectedPlatforms.some(p => p.value === 'tiktok' || p.value === 'instagram');

            // Valid if: has platforms AND (has video OR only text-friendly platforms with caption)
            const isValid = selectedPlatforms.length > 0 &&
                           (selectedFile || (onlyTextFriendly && caption.length > 0));

            console.log('updatePublishButton:', {
                selectedPlatforms: selectedPlatforms.map(p => p.value),
                caption: caption,
                captionLength: caption.length,
                selectedFile: !!selectedFile,
                onlyTextFriendly,
                isValid
            });

            btn.disabled = !isValid;

            if (scheduleToggle.checked) {
                btn.textContent = 'Schedule Post';
            } else {
                btn.textContent = selectedFile ? 'Publish Now' : 'Post Text';
            }
        }

        async function handleSubmit(e, isDraft = false) {
            console.log('========== UPLOAD SUBMIT START ==========');
            console.log('handleSubmit called, isDraft:', isDraft);
            if (e) e.preventDefault();

            if (!currentUser) {
                console.log('[ERROR] No user!');
                alert('Please login first');
                return;
            }
            console.log('[USER] ID:', currentUser.id);
            console.log('[USER] Email:', currentUser.email);

            const caption = document.getElementById('caption').value;
            console.log('[INPUT] Caption length:', caption.length);
            console.log('[INPUT] Selected file:', selectedFile ? `${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)` : 'none');
            const selectedPlatforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked'))
                .map(input => input.value);
            console.log('[INPUT] Selected platforms:', selectedPlatforms);

            const scheduleToggle = document.getElementById('schedule-toggle');
            const scheduleDate = document.getElementById('schedule-date').value;

            if (!isDraft && selectedPlatforms.length === 0) {
                console.log('[VALIDATION] No platforms selected');
                alert('Please select at least one platform');
                return;
            }

            // Confirm platforms before publishing
            if (!isDraft) {
                const platformNames = selectedPlatforms.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(', ');
                const confirmed = confirm(`Post to: ${platformNames}\n\nAre you sure?`);
                if (!confirmed) {
                    console.log('[VALIDATION] User cancelled publish');
                    return;
                }
            }

            // Check media requirements
            const needsTikTok = selectedPlatforms.includes('tiktok');
            const needsInstagram = selectedPlatforms.includes('instagram');

            // TikTok requires video (no images)
            if (needsTikTok && (!selectedFile || selectedMediaType !== 'video') && !isDraft) {
                console.log('[VALIDATION] TikTok requires video');
                alert('TikTok requires a video. Please upload a video or deselect TikTok.');
                return;
            }

            // Instagram requires some media (image or video)
            if (needsInstagram && !selectedFile && !isDraft) {
                console.log('[VALIDATION] Instagram requires media');
                alert('Instagram requires an image or video.');
                return;
            }

            if (!selectedFile && !caption && !isDraft) {
                console.log('[VALIDATION] No media and no caption');
                alert('Please add a caption or upload media');
                return;
            }

            console.log('[VALIDATION] All checks passed, proceeding...');
            const publishBtn = document.getElementById('publish-btn');
            publishBtn.disabled = true;
            publishBtn.textContent = 'Preparing...';

            // Show modal early if not a draft
            if (!isDraft && !document.getElementById('schedule-toggle').checked) {
                showPublishingModal(selectedPlatforms);
                // Set all to "Preparing..." initially
                selectedPlatforms.forEach(p => updatePlatformProgress(p, '', 'Preparing...'));
            }

            try {
                let mediaUrl = null;
                let thumbnailUrl = null;
                let metadata = {
                    media_type: selectedMediaType, // 'image' or 'video' or null
                };

                const isImage = selectedMediaType === 'image';
                const isVideo = selectedMediaType === 'video';

                // Instagram needs R2 for both images and videos
                const needsR2Upload = selectedPlatforms.includes('instagram') && selectedFile;
                // LinkedIn video upload (images handled differently)
                const needsLinkedInVideo = selectedPlatforms.includes('linkedin') && selectedFile && isVideo;
                // TikTok only supports video
                const needsTikTokVideo = selectedPlatforms.includes('tiktok') && selectedFile;

                // 1. Upload thumbnail (always, if we have video)
                if (selectedFile && videoThumbnailBlob) {
                    console.log('[THUMBNAIL] Uploading thumbnail...');
                    const thumbFileName = `${currentUser.id}/${Date.now()}_thumb.jpg`;

                    const { error: thumbError } = await supabaseClient.storage
                        .from('videos')
                        .upload(thumbFileName, videoThumbnailBlob, { contentType: 'image/jpeg' });

                    if (thumbError) {
                        console.error('[THUMBNAIL] Upload failed:', thumbError.message);
                    } else {
                        const { data: { publicUrl } } = supabaseClient.storage
                            .from('videos')
                            .getPublicUrl(thumbFileName);
                        thumbnailUrl = publicUrl;
                        console.log('[THUMBNAIL] Uploaded:', thumbnailUrl);
                    }
                }

                // 2. Upload video to LinkedIn directly (if LinkedIn selected with video)
                if (needsLinkedInVideo) {
                    console.log('[LINKEDIN] Uploading video directly to LinkedIn...');
                    publishBtn.textContent = 'Uploading to LinkedIn...';
                    updatePlatformProgress('linkedin', 'publishing', 'Uploading video...');

                    try {
                        const { data: { session } } = await supabaseClient.auth.getSession();

                        // Init upload
                        const initRes = await fetch('/api/broadcast/linkedin/init-video', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${session.access_token}`
                            },
                            body: JSON.stringify({ fileSizeBytes: selectedFile.size })
                        });

                        if (!initRes.ok) {
                            const err = await initRes.json();
                            throw new Error(err.error || 'Failed to init LinkedIn upload');
                        }

                        const { uploadUrl, videoUrn } = await initRes.json();
                        console.log('[LINKEDIN] Got upload URL, uploading video...');

                        // Upload video directly to LinkedIn
                        const uploadRes = await fetch(uploadUrl, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/octet-stream' },
                            body: selectedFile
                        });

                        if (!uploadRes.ok) {
                            throw new Error('Failed to upload video to LinkedIn');
                        }

                        console.log('[LINKEDIN] Video uploaded! URN:', videoUrn);
                        metadata.linkedin_video_urn = videoUrn;

                    } catch (linkedinError) {
                        console.error('[LINKEDIN] Video upload failed:', linkedinError.message);
                        updatePlatformProgress('linkedin', '', 'Will post as text');
                        // Continue anyway - will fall back to text post
                    }
                }

                // 2b. Upload video directly to TikTok (if TikTok selected with video)
                if (needsTikTokVideo) {
                    console.log('[TIKTOK] Uploading video directly to TikTok...');
                    publishBtn.textContent = 'Uploading to TikTok...';
                    updatePlatformProgress('tiktok', 'publishing', 'Uploading video...');

                    try {
                        const { data: { session } } = await supabaseClient.auth.getSession();

                        // Init upload
                        const initRes = await fetch('/api/broadcast/tiktok/init-video', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${session.access_token}`
                            },
                            body: JSON.stringify({ fileSizeBytes: selectedFile.size })
                        });

                        if (!initRes.ok) {
                            const err = await initRes.json();
                            throw new Error(err.error || 'Failed to init TikTok upload');
                        }

                        const { uploadUrl, publishId } = await initRes.json();
                        console.log('[TIKTOK] Got upload URL, uploading video...');

                        // Upload video directly to TikTok
                        const uploadRes = await fetch(uploadUrl, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'video/mp4',
                                'Content-Range': `bytes 0-${selectedFile.size - 1}/${selectedFile.size}`,
                            },
                            body: selectedFile
                        });

                        if (!uploadRes.ok) {
                            const errText = await uploadRes.text();
                            console.error('[TIKTOK] Upload failed:', errText);
                            throw new Error('Failed to upload video to TikTok');
                        }

                        console.log('[TIKTOK] Video uploaded! Publish ID:', publishId);
                        metadata.tiktok_publish_id = publishId;

                    } catch (tiktokError) {
                        console.error('[TIKTOK] Video upload failed:', tiktokError.message);
                        updatePlatformProgress('tiktok', 'failed', 'Upload failed');
                        // Store error so publish.js knows upload failed
                        metadata.tiktok_upload_error = tiktokError.message;
                    }
                }

                // 3. Upload media to R2 (for Instagram/Threads - handles images and videos)
                if (selectedFile && needsR2Upload) {
                    const mediaTypeLabel = isImage ? 'image' : 'video';
                    console.log(`[R2] Uploading ${mediaTypeLabel} for Instagram...`);
                    publishBtn.textContent = `Uploading ${mediaTypeLabel}...`;
                    updatePlatformProgress('instagram', 'publishing', `Uploading ${mediaTypeLabel}...`);

                    const { data: { session } } = await supabaseClient.auth.getSession();

                    // Get presigned upload URL from our API
                    const presignRes = await fetch('/api/upload-video', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify({
                            fileName: selectedFile.name,
                            contentType: selectedFile.type
                        })
                    });

                    if (!presignRes.ok) {
                        const err = await presignRes.json();
                        throw new Error(err.error || 'Failed to get upload URL');
                    }

                    const { uploadUrl, key, publicUrl } = await presignRes.json();
                    console.log('[R2] Got presigned URL, uploading...');

                    // Upload directly to R2
                    const uploadRes = await fetch(uploadUrl, {
                        method: 'PUT',
                        headers: { 'Content-Type': selectedFile.type },
                        body: selectedFile
                    });

                    if (!uploadRes.ok) {
                        throw new Error(`Failed to upload ${mediaTypeLabel} to R2`);
                    }

                    mediaUrl = publicUrl;
                    metadata.r2_key = key; // Store key for deletion after publish
                    console.log(`[R2] ${mediaTypeLabel} uploaded:`, mediaUrl);
                }

                // 4. Create post record
                publishBtn.textContent = 'Creating post...';
                console.log('[DB] Creating post record...');
                const postData = {
                    user_id: currentUser.id,
                    video_url: mediaUrl, // Now can be image or video URL
                    thumbnail_url: thumbnailUrl,
                    caption: caption,
                    platforms: selectedPlatforms,
                    status: isDraft ? 'draft' : (scheduleToggle.checked ? 'scheduled' : 'publishing'),
                    scheduled_at: scheduleToggle.checked ? scheduleDate : null,
                    platform_results: {},
                    metadata: metadata
                };
                console.log('[DB] Post data:', JSON.stringify(postData, null, 2));

                const { data: post, error: postError } = await supabaseClient
                    .from('posts')
                    .insert(postData)
                    .select()
                    .single();

                if (postError) {
                    console.error('[DB] Post insert failed:', postError.message);
                    throw postError;
                }

                console.log('[DB] Post created:', post.id);

                // 5. If publishing now, trigger the publish API
                if (!isDraft && !scheduleToggle.checked) {
                    // Show the publishing modal
                    showPublishingModal(selectedPlatforms);

                    // Update each platform to "Publishing..." state
                    selectedPlatforms.forEach(p => updatePlatformProgress(p, 'publishing', 'Publishing...'));

                    console.log('Publishing to platforms:', selectedPlatforms);
                    const publishResult = await publishToAllPlatforms(post.id, selectedPlatforms);
                    console.log('Publish result:', publishResult);

                    // Update each platform's status based on results
                    let successCount = 0;
                    const totalCount = selectedPlatforms.length;

                    for (const [platform, result] of Object.entries(publishResult.results || {})) {
                        if (result.status === 'success') {
                            successCount++;
                            const successMsg = result.url ? 'Posted!' : (result.note || 'Success!');
                            updatePlatformProgress(platform, 'success', successMsg);
                        } else {
                            const errorMsg = result.error || 'Failed';
                            updatePlatformProgress(platform, 'failed', errorMsg);
                        }
                    }

                    // Complete the modal
                    completePublishingModal(publishResult.status, successCount, totalCount);

                    console.log('PUBLISH COMPLETE:', publishResult);
                    return;
                }

                // Redirect to dashboard
                alert(isDraft ? 'Draft saved!' : (scheduleToggle.checked ? 'Post scheduled!' : 'Post published!'));
                window.location.href = './';

            } catch (error) {
                console.error('========== UPLOAD ERROR ==========');
                console.error('[ERROR] Name:', error.name);
                console.error('[ERROR] Message:', error.message);
                console.error('[ERROR] Code:', error.code);
                console.error('[ERROR] Details:', error.details);
                console.error('[ERROR] Hint:', error.hint);
                console.error('[ERROR] Full error:', JSON.stringify(error, null, 2));
                console.error('[ERROR] Stack:', error.stack);

                // More descriptive error message
                let errorMsg = error.message || 'Unknown error';
                if (error.message?.includes('row-level security')) {
                    errorMsg = 'Permission denied. Check the browser console for details.';
                }

                // Hide modal if it's showing and show alert
                const modal = document.getElementById('publishing-modal');
                if (modal.style.display === 'flex') {
                    // Update modal to show error state
                    const modalIcon = document.getElementById('modal-icon');
                    const modalTitle = document.getElementById('modal-title');
                    const modalSubtitle = document.getElementById('modal-subtitle');
                    const modalActions = document.getElementById('modal-actions');

                    modalIcon.innerHTML = '';
                    modalIcon.className = 'modal-icon failed';
                    modalTitle.textContent = 'Something went wrong';
                    modalSubtitle.textContent = errorMsg;
                    modalActions.style.display = 'block';
                } else {
                    alert('Error: ' + errorMsg);
                }

                publishBtn.disabled = false;
                publishBtn.textContent = 'Publish Now';
            }
        }

        function formatPublishResults(results) {
            return Object.entries(results).map(([platform, result]) => {
                const icon = result.status === 'success' ? '‚úì' : '‚úó';
                const msg = result.error || result.note || result.url || 'OK';
                return `${icon} ${platform.toUpperCase()}: ${msg}`;
            }).join('\n');
        }

        // Platform display info
        const platformInfo = {
            linkedin: { name: 'LinkedIn', icon: '<i class="fa-brands fa-linkedin"></i>' },
            tiktok: { name: 'TikTok', icon: '<i class="fa-brands fa-tiktok"></i>' },
            instagram: { name: 'Instagram', icon: '<i class="fa-brands fa-instagram"></i>' },
            threads: { name: 'Threads', icon: '<i class="fa-brands fa-threads"></i>' }
        };

        function showPublishingModal(platforms) {
            const modal = document.getElementById('publishing-modal');
            const progressContainer = document.getElementById('publish-progress');
            const modalIcon = document.getElementById('modal-icon');
            const modalTitle = document.getElementById('modal-title');
            const modalSubtitle = document.getElementById('modal-subtitle');
            const modalActions = document.getElementById('modal-actions');

            // Reset modal state
            modalIcon.innerHTML = '<div class="spinner"></div>';
            modalIcon.className = 'modal-icon';
            modalTitle.textContent = 'Publishing your post...';
            modalSubtitle.textContent = 'This may take a moment';
            modalActions.style.display = 'none';

            // Build progress items
            progressContainer.innerHTML = platforms.map(platform => {
                const info = platformInfo[platform] || { name: platform, icon: 'üì±' };
                return `
                    <div class="progress-item" id="progress-${platform}" data-platform="${platform}">
                        <div class="progress-icon ${platform}">${info.icon}</div>
                        <div class="progress-info">
                            <h4>${info.name}</h4>
                            <p id="progress-${platform}-status">Waiting...</p>
                        </div>
                        <div class="progress-status" id="progress-${platform}-icon">
                            <div class="mini-spinner"></div>
                        </div>
                    </div>
                `;
            }).join('');

            modal.style.display = 'flex';
        }

        function updatePlatformProgress(platform, status, message) {
            const item = document.getElementById(`progress-${platform}`);
            const statusText = document.getElementById(`progress-${platform}-status`);
            const statusIcon = document.getElementById(`progress-${platform}-icon`);

            if (!item) return;

            item.className = `progress-item ${status}`;
            statusText.textContent = message;
            statusIcon.innerHTML = '';
            statusIcon.className = `progress-status ${status}`;
        }

        function completePublishingModal(overallStatus, successCount, totalCount) {
            const modalIcon = document.getElementById('modal-icon');
            const modalTitle = document.getElementById('modal-title');
            const modalSubtitle = document.getElementById('modal-subtitle');
            const modalActions = document.getElementById('modal-actions');

            modalIcon.innerHTML = '';

            if (overallStatus === 'published') {
                modalIcon.className = 'modal-icon success';
                modalTitle.textContent = 'Published successfully!';
                modalSubtitle.textContent = `Posted to ${successCount} platform${successCount > 1 ? 's' : ''}`;
            } else if (overallStatus === 'partial') {
                modalIcon.className = 'modal-icon partial';
                modalTitle.textContent = 'Partially published';
                modalSubtitle.textContent = `${successCount} of ${totalCount} platforms succeeded`;
            } else {
                modalIcon.className = 'modal-icon failed';
                modalTitle.textContent = 'Publishing failed';
                modalSubtitle.textContent = 'Check the details below';
            }

            modalActions.style.display = 'block';
        }

        async function publishToAllPlatforms(postId, platforms) {
            console.log('Getting session for publish...');
            const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();

            if (sessionError || !session) {
                console.error('Session error:', sessionError);
                throw new Error('No valid session. Please login again.');
            }

            console.log('Calling publish API...');
            const response = await fetch('/api/broadcast/publish', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${session.access_token}`
                },
                body: JSON.stringify({ postId, platforms })
            });

            console.log('Publish API response status:', response.status);

            if (!response.ok) {
                const error = await response.json();
                console.error('Publish API error:', error);
                throw new Error(error.error || error.message || 'Failed to publish');
            }

            return response.json();
        }

        // ========== HOOK ANALYZER ==========
        let analysisInProgress = false;

        // Analyze hook handler
        document.getElementById('analyze-hook-btn')?.addEventListener('click', async () => {
            if (analysisInProgress) return;

            // Make sure we have a thumbnail
            if (!videoThumbnailBlob) {
                alert('Please wait for the video to load, then try again.');
                return;
            }

            analysisInProgress = true;
            const btn = document.getElementById('analyze-hook-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analyzing...';

            // Show modal with loading state
            showAnalysisLoading();

            try {
                // Convert thumbnail blob to base64
                const base64 = await blobToBase64(videoThumbnailBlob);

                // Get session for auth
                const { data: { session } } = await supabaseClient.auth.getSession();

                // Call analyze API
                const response = await fetch('/api/broadcast/analyze-hook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({ frameBase64: base64 })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Analysis failed');
                }

                const result = await response.json();
                showAnalysisResult(result);

            } catch (error) {
                console.error('[ANALYZE] Error:', error);
                showAnalysisError(error.message);
            } finally {
                analysisInProgress = false;
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Analyze Hook';
            }
        });

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function showAnalysisLoading() {
            const modal = document.getElementById('hook-analysis-modal');

            // Reset to loading state
            document.getElementById('viral-score-value').textContent = '--';
            document.getElementById('score-circle').style.strokeDashoffset = '283';
            document.getElementById('score-label').textContent = 'Analyzing...';
            document.getElementById('extracted-text-display').innerHTML = '<em>Detecting text...</em>';
            document.getElementById('strengths-list').innerHTML = '<li>Analyzing...</li>';
            document.getElementById('weaknesses-list').innerHTML = '<li>Analyzing...</li>';
            document.getElementById('suggestions-list').innerHTML = '<li>Generating suggestions...</li>';
            document.getElementById('similar-hooks-section').style.display = 'none';

            modal.style.display = 'flex';
        }

        function showAnalysisResult(result) {
            // Viral score with animation
            const scoreValue = document.getElementById('viral-score-value');
            const scoreCircle = document.getElementById('score-circle');
            const scoreLabel = document.getElementById('score-label');

            scoreValue.textContent = result.viral_score;
            scoreLabel.textContent = 'Viral Score';

            // Animate circle (283 is full circumference)
            const offset = 283 - (283 * result.viral_score / 100);
            scoreCircle.style.strokeDashoffset = offset;

            // Color based on score
            if (result.viral_score >= 70) {
                scoreCircle.style.stroke = '#16a34a';
                scoreValue.style.color = '#16a34a';
            } else if (result.viral_score >= 40) {
                scoreCircle.style.stroke = '#f59e0b';
                scoreValue.style.color = '#f59e0b';
            } else {
                scoreCircle.style.stroke = '#ef4444';
                scoreValue.style.color = '#ef4444';
            }

            // Extracted text
            const textDisplay = document.getElementById('extracted-text-display');
            if (result.extracted_text && result.extracted_text.trim()) {
                textDisplay.innerHTML = `"${result.extracted_text}"`;
            } else {
                textDisplay.innerHTML = '<em>No text detected in hook</em>';
            }

            // Strengths
            const strengthsList = document.getElementById('strengths-list');
            strengthsList.innerHTML = (result.analysis?.strengths || [])
                .map(s => `<li>${s}</li>`).join('') || '<li>--</li>';

            // Weaknesses
            const weaknessesList = document.getElementById('weaknesses-list');
            weaknessesList.innerHTML = (result.analysis?.weaknesses || [])
                .map(w => `<li>${w}</li>`).join('') || '<li>--</li>';

            // Suggestions
            const suggestionsList = document.getElementById('suggestions-list');
            suggestionsList.innerHTML = (result.suggestions || [])
                .map(s => `<li>${s}</li>`).join('') || '<li>No suggestions</li>';

            // Similar hooks
            const hooksSection = document.getElementById('similar-hooks-section');
            const hooksGrid = document.getElementById('similar-hooks-grid');

            if (result.similar_hooks && result.similar_hooks.length > 0) {
                hooksSection.style.display = 'block';
                hooksGrid.innerHTML = result.similar_hooks.map(hook => `
                    <div class="similar-hook-card">
                        <div class="hook-text">"${hook.hook_text}"</div>
                        <div class="hook-meta">
                            <span class="hook-category">${hook.category}</span>
                            <span class="hook-views">${formatViews(hook.avg_views)}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                hooksSection.style.display = 'none';
            }
        }

        function showAnalysisError(message) {
            document.getElementById('viral-score-value').textContent = '!';
            document.getElementById('viral-score-value').style.color = '#ef4444';
            document.getElementById('score-label').textContent = 'Analysis failed';
            document.getElementById('extracted-text-display').innerHTML = `<em style="color: #ef4444;">${message}</em>`;
            document.getElementById('strengths-list').innerHTML = '';
            document.getElementById('weaknesses-list').innerHTML = '';
            document.getElementById('suggestions-list').innerHTML = '<li>Please try again later</li>';
        }

        function formatViews(views) {
            if (!views) return '';
            if (views >= 1000000) return (views / 1000000).toFixed(1) + 'M avg views';
            if (views >= 1000) return (views / 1000).toFixed(0) + 'K avg views';
            return views + ' avg views';
        }

        // Close modal handlers
        document.getElementById('close-analysis-modal')?.addEventListener('click', () => {
            document.getElementById('hook-analysis-modal').style.display = 'none';
        });

        document.getElementById('close-analysis-btn')?.addEventListener('click', () => {
            document.getElementById('hook-analysis-modal').style.display = 'none';
        });

        // Close on outside click
        document.getElementById('hook-analysis-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'hook-analysis-modal') {
                document.getElementById('hook-analysis-modal').style.display = 'none';
            }
        });
    </script>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-content.publishing-modal {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .modal-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-icon .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #1e40af;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .modal-icon.success {
            background: #dcfce7;
            border-radius: 50%;
        }
        .modal-icon.success::after {
            content: '‚úì';
            font-size: 2rem;
            color: #16a34a;
        }
        .modal-icon.partial {
            background: #fef3c7;
            border-radius: 50%;
        }
        .modal-icon.partial::after {
            content: '‚ö†';
            font-size: 2rem;
        }
        .modal-icon.failed {
            background: #fee2e2;
            border-radius: 50%;
        }
        .modal-icon.failed::after {
            content: '‚úó';
            font-size: 2rem;
            color: #dc2626;
        }
        .modal-header h2 {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }
        .modal-subtitle {
            color: #6b7280;
            font-size: 0.9rem;
            margin: 0;
        }
        .publish-progress {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .progress-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            background: #f9fafb;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .progress-item.publishing {
            border-color: #1e40af;
            background: #eff6ff;
        }
        .progress-item.success {
            border-color: #16a34a;
            background: #f0fdf4;
        }
        .progress-item.failed {
            border-color: #dc2626;
            background: #fef2f2;
        }
        .progress-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        .progress-icon.linkedin { background: #0A66C2; color: white; }
        .progress-icon.tiktok { background: #000000; color: white; }
        .progress-icon.instagram { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: white; }
        .progress-icon.threads { background: #000000; color: white; }
        .progress-info {
            flex: 1;
            min-width: 0;
        }
        .progress-info h4 {
            font-size: 0.95rem;
            margin: 0 0 0.125rem 0;
        }
        .progress-info p {
            font-size: 0.8rem;
            color: #6b7280;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .progress-status {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .progress-status .mini-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top-color: #1e40af;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .progress-status.success::after {
            content: '‚úì';
            color: #16a34a;
            font-weight: bold;
            font-size: 1rem;
        }
        .progress-status.failed::after {
            content: '‚úó';
            color: #dc2626;
            font-weight: bold;
            font-size: 1rem;
        }
        .modal-actions {
            margin-top: 1.5rem;
            text-align: center;
        }
        .modal-actions .btn {
            width: 100%;
        }

        /* Hook Analysis Modal Styles */
        .hook-analysis-modal {
            max-width: 520px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        /* Viral Score Ring */
        .viral-score-container {
            text-align: center;
            margin: 1.5rem 0;
        }
        .viral-score-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            position: relative;
        }
        .viral-score-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .score-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 8;
        }
        .score-progress {
            fill: none;
            stroke: #1e40af;
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1s ease-out, stroke 0.3s;
        }
        .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: 700;
            color: #1e40af;
            transition: color 0.3s;
        }
        .score-label {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }

        /* Analysis Sections */
        .analysis-section {
            background: #f9fafb;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .analysis-section h3 {
            font-size: 0.95rem;
            font-weight: 600;
            margin: 0 0 0.75rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #374151;
        }
        .analysis-section h3 i {
            font-size: 0.9rem;
        }
        .analysis-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .strengths h3 i { color: #16a34a; }
        .weaknesses h3 i { color: #f59e0b; }
        .suggestions h3 i { color: #3b82f6; }
        .similar-hooks h3 i { color: #ef4444; }

        .analysis-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .analysis-section li {
            font-size: 0.85rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
            color: #4b5563;
        }
        .analysis-section li:last-child {
            border-bottom: none;
        }
        .extracted-text {
            font-size: 1rem;
            font-weight: 500;
            padding: 0.75rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            color: #1f2937;
        }

        /* Similar Hooks Grid */
        .similar-hooks-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .similar-hook-card {
            padding: 0.75rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .similar-hook-card .hook-text {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }
        .similar-hook-card .hook-meta {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .similar-hook-card .hook-category {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            background: #eff6ff;
            color: #1e40af;
            border-radius: 4px;
            text-transform: capitalize;
        }
        .similar-hook-card .hook-views {
            font-size: 0.75rem;
            color: #6b7280;
        }

        @media (max-width: 640px) {
            .analysis-row {
                grid-template-columns: 1fr;
            }
            .hook-analysis-modal {
                max-width: 95%;
                padding: 1.5rem;
            }
        }
    </style>
</body>
</html>
