<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posting Calendar - Lexaya</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/broadcast/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <a href="./" class="logo">‚Üê Back to Dashboard</a>
            <h1>Posting Calendar</h1>
            <p class="tagline">Track your posting consistency</p>
        </header>

        <!-- Auth Check -->
        <div id="auth-required" class="auth-required" style="display: none;">
            <div class="card">
                <h2>Login Required</h2>
                <p>Please login to view your calendar</p>
                <a href="/login.html?redirect=/broadcast/calendar.html" class="btn btn-primary">Login with Email</a>
            </div>
        </div>

        <!-- Calendar -->
        <main id="calendar-main" style="display: none;">
            <div class="calendar-container">
                <!-- Month Navigation -->
                <div class="month-nav">
                    <button id="prev-month" class="btn btn-secondary">&lt;</button>
                    <h2 id="month-year"></h2>
                    <button id="next-month" class="btn btn-secondary">&gt;</button>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-grid">
                    <div class="calendar-header">Sun</div>
                    <div class="calendar-header">Mon</div>
                    <div class="calendar-header">Tue</div>
                    <div class="calendar-header">Wed</div>
                    <div class="calendar-header">Thu</div>
                    <div class="calendar-header">Fri</div>
                    <div class="calendar-header">Sat</div>
                </div>
                <div id="calendar-days" class="calendar-days"></div>
            </div>

            <!-- Legend -->
            <div class="calendar-legend">
                <div class="legend-item">
                    <span class="legend-emoji">üé¨</span>
                    <span>Posted</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot"></span>
                    <span>Today</span>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Config
        const SUPABASE_URL = 'https://bcyhcsphmqizzvzmdqxc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjeWhjc3BobXFpenp2em1kcXhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNjEwMjQsImV4cCI6MjA4MTczNzAyNH0.8CGKr_2IzxmdcCidKE0pIpsGJnkDKIYmNxDtns2ZRFk';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        const ADMIN_EMAILS = ['sanslamsal16@gmail.com'];
        let currentDate = new Date();
        let postDates = new Set();

        document.addEventListener('DOMContentLoaded', async () => {
            // Check localStorage first to reduce auth requests
            let user = null;
            const cachedUser = localStorage.getItem('supabase_user');

            if (cachedUser) {
                try {
                    user = JSON.parse(cachedUser);
                } catch (e) {
                    localStorage.removeItem('supabase_user');
                }
            }

            // Verify with Supabase if no cached user
            if (!user) {
                const { data } = await supabaseClient.auth.getUser();
                user = data.user;
                if (user) {
                    localStorage.setItem('supabase_user', JSON.stringify(user));
                }
            }

            currentUser = user;

            const authRequired = document.getElementById('auth-required');
            const calendarMain = document.getElementById('calendar-main');

            if (!currentUser) {
                authRequired.style.display = 'flex';
                calendarMain.style.display = 'none';
                return;
            }

            // Admin bypass - skip subscription check
            if (!ADMIN_EMAILS.includes(currentUser.email)) {
                const { data: subscription } = await supabaseClient
                    .from('subscriptions')
                    .select('*')
                    .eq('customer_email', currentUser.email)
                    .eq('product_key', 'broadcast')
                    .in('status', ['active', 'trialing'])
                    .single();

                if (!subscription) {
                    window.location.href = '/broadcast/pricing.html';
                    return;
                }
            }

            authRequired.style.display = 'none';
            calendarMain.style.display = 'block';

            // Set up navigation
            document.getElementById('prev-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            document.getElementById('next-month').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            await renderCalendar();
        });

        async function loadPostsForMonth(year, month) {
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0, 23, 59, 59);

            const { data: posts, error } = await supabaseClient
                .from('posts')
                .select('created_at, published_at, status')
                .eq('user_id', currentUser.id)
                .gte('created_at', startDate.toISOString())
                .lte('created_at', endDate.toISOString());

            if (error) {
                console.error('Error loading posts:', error);
                return new Set();
            }

            // Get unique dates that have posts
            const dates = new Set();
            posts?.forEach(post => {
                const date = new Date(post.created_at);
                dates.add(date.getDate());
            });

            return dates;
        }

        async function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Update month/year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('month-year').textContent = `${monthNames[month]} ${year}`;

            // Load posts for this month
            postDates = await loadPostsForMonth(year, month);

            // Get first day of month and total days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            // Build calendar HTML
            let html = '';

            // Empty cells for days before first of month
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = today.getFullYear() === year &&
                               today.getMonth() === month &&
                               today.getDate() === day;
                const hasPost = postDates.has(day);

                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (hasPost) classes += ' has-post';

                html += `<div class="${classes}">
                    <span class="day-number">${day}</span>
                    ${hasPost ? '<span class="post-emoji">üé¨</span>' : ''}
                </div>`;
            }

            document.getElementById('calendar-days').innerHTML = html;
        }
    </script>
</body>
</html>
